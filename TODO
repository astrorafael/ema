Prioridad alta
==============

- EL README esta hecho unos zorros

- documentar el SCHEDULER en el README


 - Comunicación al modulo MQTT con Colas deque() para desacoplar el servicio
  MQTT del servicio de lectura.
*)  revisar los intervalos window deben ser [0,24)
*) Una unica EMA no se registra al MQTT si sus parametros seleccionados de registro no han podido
   obtenerse
*) Topic MQTT
	  EMA/register
	  EMA/<channel>/events
	  EMA/<channel>/current/state
	  EMA/<channel>/historic/minmax
	  EMA/<channel>/historic/dailyaverage
*) Eventos JSON (¿con retained?)
   - Ya estoy en linea de nuevo
   - error de registro
   - error en bulk dump
*) Servicio MQTTClient para stars4all


import json
import datetime
import re


class DateTimeEncoder(json.JSONEncoder):

    def default(self, o):
        if  isinstance(o, datetime.datetime):
            return o.strftime("%Y-%m-%dT%H:%M:%S")

        # Let the base class default method raise the TypeError
        return json.JSONEncoder.default(self, o)


Prioreidad baja
===============
*) API REST de telegestion por HTTP (Usar klein?)
mirar diseño de API en http://dev.enchant.com/api/v1
*) Repasar unidades, escala y rango  de los comandos


PILLAR ERROR CUANDO FALTA MUY PPOCO QUE MPIECEUN INTERVALO ACTIVO

2016-07-10T08:57:42+0000 [sched#info] starting Scheduler Service
2016-07-10T08:57:42+0000 [twisted.internet.defer#critical] Unhandled error in Deferred:

Traceback (most recent call last):
  File "/usr/local/lib/python2.7/dist-packages/twisted/internet/defer.py", line 393, in callback
    self._startRunCallbacks(result)
  File "/usr/local/lib/python2.7/dist-packages/twisted/internet/defer.py", line 501, in _startRunCallbacks
    self._runCallbacks()
  File "/usr/local/lib/python2.7/dist-packages/twisted/internet/defer.py", line 588, in _runCallbacks
    current.result = callback(current.result, *args, **kw)
  File "/usr/local/lib/python2.7/dist-packages/twisted/internet/defer.py", line 1184, in gotResult
    _inlineCallbacks(r, g, deferred)
--- <exception caught here> ---
  File "/usr/local/lib/python2.7/dist-packages/twisted/internet/defer.py", line 1128, in _inlineCallbacks
    result = g.send(result)
  File "ema/ema.py", line 217, in _maybeExit
    self.addActivities()
  File "ema/ema.py", line 196, in addActivities
    active, inactive = self.schedulerService.findCurrentInterval()
  File "ema/scheduler.py", line 444, in findCurrentInterval
    inactive = self.gaps[i]
  File "ema/scheduler.py", line 270, in __getitem__
    return self.windows[i]
exceptions.TypeError: list indices must be integers, not NoneType
^C2016-07-10T08:57:48+0000 [-] Received SIGINT, shutting down.
2016-07-10T08:57:48+0000 [-] Main loop terminated.
